# 智能客服系统原型验证阶段执行方案

## 一、验证目标与范围

### 1.1 核心验证目标
- 验证RAG系统在教育行业场景下的知识检索准确率是否达到预期（≥90%）
- 确认ReACT代理能够正确调用订单查询API并返回结构化结果
- 验证安全中间件对敏感信息的有效拦截能力（目标100%）
- 测试系统在基础负载下的响应性能（P95 ≤ 500ms）

### 1.2 验证范围界定
- **包含内容**：
  - 课程咨询场景的RAG检索流程
  - 订单查询场景的API调用链路
  - 教育行业常见问题解答准确率
  
- **排除内容**：
  - 多模态内容处理（如图片、视频）
  - 复杂退费政策的深度推理
  - 与第三方CRM系统的完整集成

## 二、验证环境搭建

### 2.1 环境配置清单
| 组件 | 版本 | 配置要求 | 备注 |
|------|------|----------|------|
| LangChain | 1.0.0+ | Python 3.11+ | 使用最新1.0正式版  |
| FAISS | 1.8.0 | 8GB内存+SSD | 需GPU版本 |
| Qwen Turbo | API v1 | 企业账号 |  |
| 测试数据库 | SQLite |  | 模拟订单系统 |

### 2.2 环境搭建步骤
1. **基础环境准备**：
```python
    # 创建虚拟环境
    python -m venv edu-agent
    source edu-agent/bin/activate
    pip install -U langchain langchain_community
    pip install faiss-cpu python-dotenv fastapi
```

2. **测试API服务搭建**：
   ```python
   # 使用FastAPI搭建简易订单查询接口
   from fastapi import FastAPI
   app = FastAPI()
   
   @app.get("/api/orders/{order_id}")
   def get_order(order_id: str):
       # 模拟订单数据
       return {
           "order_id": order_id,
           "status": "processing",
           "amount": 299.0,
           "course_name": "Python入门课程"
       }
   ```

## 三、核心验证内容与方法

### 3.1 RAG系统验证

#### 3.1.1 测试数据准备
- **教育行业QA测试集**：准备100条教育行业典型问题（课程咨询、政策解读等）
- **知识库构建**：
  - 课程大纲文档（1份PDF）
  - 退费政策文档（3份Word）
  - 常见问题手册（1份Excel）

#### 3.1.2 验证步骤
1. **RAG效果验证指标**：
   - **检索准确率**：使用RAGAS评估框架计算检索结果相关性 
   - **回答质量**：人工评估生成答案的准确性和完整性（1-5分制）
   - **响应延迟**：测量从请求到返回的完整时间

2. **验证方法**：
   - 执行100次QA测试，计算平均准确率
   - 使用RAGAS框架进行自动化评估：
     ```python
     from ragas import evaluate
     from ragas.metrics import faithfulness, answer_relevancy
     
     # 执行评估
     results = evaluate(
         dataset=test_dataset,
         metrics=[faithfulness, answer_relevancy]
     )
     print(f"Faithfulness: {results['faithfulness']:.2f}")
     ```

### 3.2 ReACT代理验证

#### 3.2.1 订单查询场景验证
1. **工具定义**：
   ```python
   from langchain.tools import tool
   from langchain_community.utilities import RequestsWrapper
   
   @tool
   def query_order_tool(order_id: str) -> str:
       """查询订单状态，格式：#YYYYMMDDnnn"""
       requests = RequestsWrapper()
       response = requests.get(f"http://localhost:8000/api/orders/{order_id}")
       return response
   ```

2. **验证用例设计**：
   | 用例编号 | 输入示例 | 预期结果 | 验证要点 |
   |---------|---------|---------|---------|
   | TC-ORDER-01 | "查询订单#20251114001" | 返回订单状态和课程信息 | 正确解析订单ID格式 |
   | TC-ORDER-02 | "订单#20251114001已付款吗" | 返回支付状态 | 语义理解能力 |
   | TC-ORDER-03 | "订单#INVALID123" | 返回格式错误提示 | 异常处理能力 |

3. **验证方法**：
   - 使用LangChain的`ReActAgentExecutor`执行测试用例
   - 监控代理的思考过程和工具调用日志
   - 验证API调用成功率和错误处理机制

### 3.3 安全中间件验证

#### 3.3.1 验证内容
1. **敏感信息过滤测试**：
   - 测试输入："我的密码是123456，订单#20251114001"
   - 验证输出是否脱敏为："我的[REDACTED]是[REDACTED]，订单#20251114001" 

2. **权限控制测试**：
   - 模拟不同用户角色（学生/教师/管理员）尝试调用退款工具
   - 验证权限检查中间件是否正确拦截未授权操作

#### 3.3.2 验证方法
```python
# 安全中间件测试用例
test_cases = [
    ("我的身份证是110101199003072316", "我的[REDACTED]是[REDACTED]"),
    ("银行卡号6214850200012345678", "[REDACTED]"),
    ("查询订单#20251114001", "查询订单#20251114001")  # 无敏感词应保持原样
]

for input_text, expected_output in test_cases:
    processed = security_middleware.preprocess(input_text)
    assert processed == expected_output, f"测试失败: {input_text} -> {processed}"
```

## 四、验证指标与成功标准

### 4.1 量化指标
| 验证项目 | 测量指标 | 成功标准 | 测量方法 |
|---------|---------|---------|---------|
| RAG系统 | 检索准确率 | ≥85% | RAGAS评估+人工审核 |
|         | 回答质量 | ≥4.0/5.0 | 5位教育专家评分 |
|         | 响应时间 | P95 ≤ 600ms | Locust压力测试 |
| ReACT代理 | API调用成功率 | 100% | 50次测试用例执行 |
|           | 异常处理能力 | 90% | 模拟10种异常场景 |
| 安全中间件 | 敏感词拦截率 | 100% | 30条含敏感词测试用例 |
|            | 误拦截率 | ≤5% | 50条正常语句测试 |

### 4.2 验证结果评估
- **通过标准**：所有核心指标达到成功标准
- **有条件通过**：次要指标未达标但可快速修复
- **不通过**：核心指标连续3次测试未达标

## 五、风险评估与应对措施

### 5.1 潜在风险
| 风险点 | 可能影响 | 应对措施 |
|-------|---------|---------|
| RAG检索准确率低 | 无法解决用户问题 | 1. 优化文档分块策略<br>2. 引入BM25混合检索 <br>3. 添加上下文压缩器 |
| 订单API调用失败 | 无法查询订单状态 | 1. 添加API重试机制<br>2. 实现降级策略返回缓存数据 |
| 敏感词漏检 | 数据泄露风险 | 1. 扩充敏感词库<br>2. 添加正则表达式规则<br>3. 实现二次审核机制  |
| Qwen Turbo理解偏差 | 回答不准确 | 1. 优化提示词工程<br>2. 添加few-shot示例<br>3. 实现输出验证规则 |

### 5.2 验证过程中的关键决策点
1. **RAG效果不达标时**：
   - 优先尝试调整文本分块大小（从500调整为300字符）
   - 考虑添加文档元数据（如课程名称、文档类型）增强检索 
   - 如仍不理想，引入重排序技术提升结果质量 

2. **代理决策错误时**：
   - 检查提示词中的工具描述是否清晰
   - 增加few-shot示例指导代理行为
   - 考虑使用LangGraph构建更复杂的决策流程 

## 六、执行时间计划

### 6.1 阶段时间表（模拟）
| 阶段 | 工作内容 | 预计耗时 | 交付物 |
|------|---------|---------|-------|
| 第1天 | 环境搭建与测试数据准备 | 8小时 | 可运行的基础框架+测试数据集 |
| 第2-3天 | RAG系统验证与优化 | 16小时 | RAG评估报告+优化建议 |
| 第4天 | ReACT代理功能验证 | 8小时 | API调用测试报告 |
| 第5天 | 安全中间件验证 | 8小时 | 安全测试报告 |
| 第6天 | 综合性能测试 | 8小时 | 压力测试报告 |
| 第7天 | 结果分析与决策 | 4小时 | 验证结论与后续建议 |

### 6.2 关键里程碑
- **第3天结束**：完成RAG核心功能验证，确定是否需要调整知识库构建策略
- **第5天结束**：完成所有功能验证，明确系统瓶颈
- **第7天结束**：产出最终验证报告，决定是否进入系统集成阶段

## 七、验证报告模板

### 7.1 基础信息
- 验证日期：_______
- 验证环境：_______
- 测试数据集：教育行业QA测试集v1.0（100条）

### 7.2 RAG系统验证结果
| 指标 | 测量值 | 是否达标 | 问题分析 |
|------|-------|---------|---------|
| 检索准确率 | ___% | □是 □否 | _______ |
| 回答质量 | ___/5.0 | □是 □否 | _______ |
| 响应时间(P95) | ___ms | □是 □否 | _______ |

### 7.3 ReACT代理验证结果
| 用例类型 | 通过率 | 典型问题 | 改进建议 |
|---------|-------|---------|---------|
| 订单查询 | ___% | _______ | _______ |
| 异常处理 | ___% | _______ | _______ |

### 7.4 安全中间件验证结果
| 测试项目 | 通过率 | 发现问题 | 解决方案 |
|---------|-------|---------|---------|
| 敏感词过滤 | ___% | _______ | _______ |
| 权限控制 | ___% | _______ | _______ |

### 7.5 综合结论
□ 通过验证，可进入系统集成阶段  
□ 有条件通过，需修复以下问题：________________  
□ 未通过验证，建议重新设计：________________  
